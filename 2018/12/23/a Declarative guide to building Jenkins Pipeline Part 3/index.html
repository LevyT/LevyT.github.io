<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="Tomer Levy"><link rel="icon" href="/tomer.jpeg"><title>Information Security &amp; DevOps</title><meta name="description" content="Information Security &amp; Devops Blog"><link rel="alternate" type="application/rss+xml" title="Information Security &amp; DevOps" href="/atom.xml"><div id="link" rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"></div><div id="link" rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"></div><link rel="stylesheet" href="images/font-awesome.min.css"><link rel="stylesheet" href="images/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Information Security &amp; DevOps</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="/about/">About</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/tomer.jpeg" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>a Declarative guide to building Jenkins Pipeline Part 3</h1><p class="post-meta">Posted on Dec 23 2018 · <a href="/tags/Docker/" class="tag post-meta">Docker</a> · <a href="/tags/Jenkins/" class="tag post-meta">Jenkins</a> · <a href="/tags/DevOps/" class="tag post-meta">DevOps</a> · <a href="/tags/Registry/" class="tag post-meta">Registry</a> · <a href="/tags/Pipelines/" class="tag post-meta">Pipelines</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><p><strong>So now that we know how to trigger build by git repositroy,<br>And how to build images to docker, it’s time we’ll push them to the registry and deploy on a server.</strong></p>
<p>First I’ll create a new private repository for me.</p>
<p>I’ll use random dynamic dns from <a href="https://no-ip.org/" target="_blank" rel="noopener">https://no-ip.org/</a></p>
<p><img src="/images/ddns.png" alt=""></p>
<p>and I will assign that DNS to a server I’m creating on AWS EC2.</p>
<p>On the creation of the instance I’m going to use this code in the User Data</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">add-apt-repository \</span><br><span class="line">   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span><br><span class="line">   $(lsb_release -cs) \</span><br><span class="line">   stable&quot;</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y docker-ce</span><br><span class="line">usermod -aG docker ubuntu</span><br><span class="line"></span><br><span class="line">curl -L https://github.com/docker/compose/releases/download/1.21.0/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>Which will automatic install Docker and Docker-compose for me on that machine.</p>
<p>Now that I have a server with Docker and Docker-compose let’s configure registry on it.</p>
<p>First I want to install LetsEncrypt for trusted SSL Certificate<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:certbot/certbot</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install certbot</span><br><span class="line">sudo certbot certonly --standalone --preferred-challenges http -d registry.bounceme.net</span><br></pre></td></tr></table></figure></p>
<p>We should get a message like:</p>
<p><code>- Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/registry.bounceme.net/fullchain.pem</code></p>
<p>We will run:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/letsencrypt/live/registry.bounceme.net/</span><br><span class="line">cp privkey.pem domain.key</span><br><span class="line">cat cert.pem chain.pem &gt; domain.crt</span><br><span class="line">chmod 777 domain.crt</span><br><span class="line">chmod 777 domain.key</span><br></pre></td></tr></table></figure>
<p> And finally launch our registry with the certificate and persistent storage-folder</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 443:5000 --restart=always --name registry \</span><br><span class="line">  -v /etc/letsencrypt/live/registry.bounceme.net:/certs \</span><br><span class="line">  -v /opt/docker-registry:/var/lib/registry \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">  -e REGISTRY_STORAGE_DELETE_ENABLED=true  \</span><br><span class="line">  registry:2</span><br></pre></td></tr></table></figure>
<p>Let’s make sure it is running</p>
<p><img src="/images/registryrunning.png" alt=""></p>
<p>Let’s also add nice UI (There are few, this one I like the most) to view and delete the images we create from the registry with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 1337:80 -e REGISTRY_HOST=registry.bounceme.net:443 \</span><br><span class="line">      -e REGISTRY_SSL=true \</span><br><span class="line">      -e REGISTRY_DOMAIN=registry.bounceme.net:443 \</span><br><span class="line">      -e REGISTRY_STORAGE_DELETE_ENABLED=true \</span><br><span class="line">      -e REGISTRY_USER=username \</span><br><span class="line">      -e REGISTRY_PASS=docker \</span><br><span class="line">      --restart=on-failure \</span><br><span class="line">      --name reg-webui jc21/registry-ui</span><br></pre></td></tr></table></figure>
<p>Great now we have a registry. test it with <code>docker login -u username -p docker registry.yours.net</code></p>
<p>Let’s add that to our pipeline, but before that we need to add our credentials to Jenkins</p>
<p>We will go to Jenkins ==&gt; Credentials ==&gt; System ==&gt; Global Credentials ==&gt; Add Credentials</p>
<p><img src="/images/privatereg.png" alt=""></p>
<p>We will use them by the ID we supplied.</p>
<p>Great, Let’s update our JenkinsFile to</p>
<iframe src="https://carbon.now.sh/embed/?bg=rgba(255%2C255%2C255%2C1)&t=dracula&wt=none&l=erlang&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=48px&ph=32px&ln=false&fm=Hack&fs=13px&lh=133%25&si=false&code=node%2520%257B%250A%2520%2520%2520%2520def%2520app%250A%250A%2520%2520%2520%2520stage('Clone%2520Repo')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520checkout%2520scm%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520stage('Build%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520app%2520%253D%2520docker.build(%2522registry.bounceme.net%252Ftest-nodejs%2522)%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520stage('Test%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520app.inside%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520sh%2520'echo%2520%2522Built%2520Successfully%2522'%250A%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520stage('Push%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520docker.withRegistry('https%253A%252F%252Fregistry.bounceme.net'%252C%2520'Private-Reg')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520app.push(%2522%2524%257Benv.BUILD_NUMBER%257D%2522)%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520app.push(%2522latest%2522)%250A%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%257D%250A%257D&es=2x&wm=false" style="transform:scale(0.7); width:1024px; height:473px; border:0; overflow:hidden;" sandbox="allow-scripts allow-same-origin"><br></iframe>


<p>So everytime we build we make it the latest build and we keep the last one also incase we want to revert.</p>
<p>Let’s run the pipeline in Jenkins,</p>
<p>And we can see the new stage added</p>
<p><img src="/images/stagenew.png" alt=""></p>
<p>Let’s also open the registry webui to view the image</p>
<p>For that I need to open port 1337 on AWS for my external ip address</p>
<p><img src="/images/allow1337.png" alt=""></p>
<p>With that being said</p>
<p>we can see the newly created image has been pushed to the registry</p>
<p><img src="/images/regwebui.png" alt=""></p>
<p>Awesome!</p>
<p><strong>Last Part is AutoMatic Deployment on a server</strong></p>
<p>For that you can use Anisble/Puppet/Chef or pure SSH like I’m going to do now.</p>
<p>First I’ll copy my ssh key to the server and allow my Jenkins container to use it.</p>
<p><code>cp key.pem /media/tomer/LHDD/VMs/Jenkins/</code></p>
<p>And I will also create docker-compose.yml file<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  node-webapp:</span><br><span class="line">    image: registry.bounceme.net/test-nodejs</span><br><span class="line">    container_name: node-webapp</span><br><span class="line">    ports:</span><br><span class="line">       - &quot;1234:8888&quot;</span><br></pre></td></tr></table></figure></p>
<p>Let’s edit our Jenkinsfile to copy it to our remote server and start it with docker-compose</p>
<iframe src="https://carbon.now.sh/embed/?bg=rgba(255%2C255%2C255%2C1)&t=dracula&wt=none&l=text%2Fturtle&ds=true&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=48px&ph=32px&ln=false&fm=Hack&fs=13px&lh=133%25&si=false&code=node%2520%257B%250A%2520%2520%2520%2520def%2520app%250A%250A%2520%2520%2520%2520stage('Clone%2520Repo')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520checkout%2520scm%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520stage('Build%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520app%2520%253D%2520docker.build(%2522registry.bounceme.net%252Ftest-nodejs%2522)%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520stage('Test%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520app.inside%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520sh%2520'echo%2520%2522Built%2520Successfully%2522'%250A%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520stage('Push%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520docker.withRegistry('https%253A%252F%252Fregistry.bounceme.net'%252C%2520'Private-Reg')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520app.push(%2522%2524%257Benv.BUILD_NUMBER%257D%2522)%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520app.push(%2522latest%2522)%250A%2520%2520%2520%2520%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%2520%2520%2520%2520stage('Deploy%2520image')%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520sh%2520%2522scp%2520-i%2520%2520~%252Fkey.pem%2520-o%2520StrictHostKeyChecking%253Dno%2520docker-compose.yml%2520ubuntu%2540registry.bounceme.net%253A%252Ftmp%252F%2522%250A%2520%2520%2520%2520%2520%2520%2520%2520sh%2520%2522ssh%2520-i%2520~%252Fkey.pem%2520ubuntu%2540registry.bounceme.net%2520'docker%2520login%2520-u%2520username%2520-p%2520docker%2520registry.bounceme.net%253B%2520docker-compose%2520-f%2520%252Ftmp%252Fdocker-compose.yml%2520up%2520-d'%2522%250A%2520%2520%2520%2520%257D%250A%257D&es=2x&wm=false" style="transform:scale(0.7); width:1024px; height:473px; border:0; overflow:hidden;" sandbox="allow-scripts allow-same-origin"><br></iframe>


<p>Awesome now we are ready to run it !</p>
<p><img src="/images/deployimage.png" alt=""></p>
<p>Cool we see it has been deployed let’s check it out</p>
<p><img src="/images/succesdeploy.png" alt=""></p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/2018/12/26/How I Drank This Website Data/" data-toggle="tooltip" data-placement="top" title="How I Drank This Website Data">← Previous Post</a></li><li class="next"><a href="/2018/12/22/a Declarative guide to building Jenkins Pipeline Part 2/" data-toggle="tooltip" data-placement="top" title="a Declarative guide to building Jenkins Pipeline Part 2">Next Post →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="/atom.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-rss"></i></span></a></li><li><a href="mailto:tl1996@gmail.com" title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-envelope"></i></span></a></li><li><a href="https://www.linkedin.com/in/tomer-levy/" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li></ul><p class="copyright text-muted">© Tomer Levy • 2019 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><div id="script" src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></div><div id="script" src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></div><script src="images/jquery.min.js"></script><script src="images/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-124261609-1', 'auto');
ga('send', 'pageview');</script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body></html>